<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Analisis Data Kelapa Sawit</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    
    <style>
        /* CSS Kustom dengan Nuansa Hijau */
        :root {
            --palm-green-dark: #004d40; /* Hijau Tua, Warna Primer */
            --palm-green-medium: #1a7d65; /* Hijau Sedang */
            --palm-green-light: #e8f5e9; /* Hijau Muda, Latar Belakang */
            --palm-accent: #ffb300; /* Aksen Kuning/Oranye (Minyak Sawit) */
        }
        body {
            background-color: var(--palm-green-light);
            color: var(--palm-green-dark);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar, .card-header {
            background-color: var(--palm-green-dark) !important;
            color: white;
        }
        .card {
            border-left: 5px solid var(--palm-green-medium);
            margin-bottom: 20px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .btn-palm {
            background-color: var(--palm-green-medium);
            color: white;
            border: none;
        }
        .btn-palm:hover {
            background-color: var(--palm-green-dark);
            color: white;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <a class="navbar-brand text-white" href="#"><i class="fas fa-seedling me-2"></i> **PALM DASHBOARD**</a>
            <span class="navbar-text text-white-50">Analisis Data Pabrik Kelapa Sawit</span>
        </div>
    </nav>

    <div class="container-fluid mt-4">
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card text-center bg-white">
                    <div class="card-body">
                        <h5 class="card-title text-muted"><i class="fas fa-oil-can me-1"></i> Produksi (Ton)</h5>
                        <p class="display-4" id="metric-produksi">15.450</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-white">
                    <div class="card-body">
                        <h5 class="card-title text-muted"><i class="fas fa-hand-holding-usd me-1"></i> Penjualan (IDR M)</h5>
                        <p class="display-4" id="metric-penjualan">45.2</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-white">
                    <div class="card-body">
                        <h5 class="card-title text-muted"><i class="fas fa-map-marker-alt me-1"></i> Area (Ha)</h5>
                        <p class="display-4" id="metric-area">3.120</p>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card text-center bg-white">
                    <div class="card-body">
                        <h5 class="card-title text-muted"><i class="fas fa-tag me-1"></i> Harga Rata-rata (/Ton)</h5>
                        <p class="display-4" id="metric-harga">7.5 Jt</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-bar me-1"></i> **Tren Produksi dan Harga**</div>
                    <div class="card-body"><canvas id="barLineChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header"><i class="fas fa-chart-pie me-1"></i> **Distribusi Penjualan**</div>
                    <div class="card-body"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
        </div>

        <div class="row mt-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <div class="d-flex justify-content-between align-items-center">
                            <span><i class="fas fa-table me-1"></i> **Data Detail Operasional**</span>
                            <button class="btn btn-sm btn-palm" onclick="unduhData()"><i class="fas fa-download me-1"></i> Unduh Data (.csv)</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="mb-3 d-flex">
                            <input type="text" class="form-control me-2" id="filterBulan" placeholder="Filter Bulan (Cth: Jan, Feb...)">
                            <input type="text" class="form-control me-2" id="filterArea" placeholder="Filter Area">
                        </div>
                        <div class="table-responsive">
                            <table class="table table-striped table-hover" id="dataTable">
                                <thead class="bg-light">
                                    <tr>
                                        <th>Bulan</th>
                                        <th>Area Tanam</th>
                                        <th>Produksi (Ton)</th>
                                        <th>Harga Rata-rata (/Ton)</th>
                                        <th>Penjualan (IDR)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ==========================================================
        // 2. KONTEKS: EKSTRAKSI DATA (Simulasi Data dari File Upload)
        // ==========================================================
        const rawData = [
            { bulan: 'Jan-24', area: 'Blok A', produksi: 1500, harga: 7500000, penjualan: 11250000000 },
            { bulan: 'Jan-24', area: 'Blok B', produksi: 500, harga: 7600000, penjualan: 3800000000 },
            { bulan: 'Feb-24', area: 'Blok A', produksi: 1400, harga: 7450000, penjualan: 10430000000 },
            { bulan: 'Feb-24', area: 'Blok C', produksi: 700, harga: 7550000, penjualan: 5285000000 },
            { bulan: 'Mar-24', area: 'Blok B', produksi: 1600, harga: 7700000, penjualan: 12320000000 },
            { bulan: 'Mar-24', area: 'Blok C', produksi: 800, harga: 7800000, penjualan: 6240000000 },
            // ... (Data tambahan bisa ditaruh di sini)
        ];

        let filteredData = [...rawData]; // Data yang akan diolah dan difilter
        
        // ==========================================================
        // 3. FUNGSI UTAMA
        // ==========================================================

        document.addEventListener('DOMContentLoaded', () => {
            renderTable(rawData);
            renderCharts(rawData);
            setupFilters();
        });

        // ----------------------------------------------------------
        // A. Render Tabel Data
        // ----------------------------------------------------------
        function renderTable(data) {
            const tableBody = document.getElementById('dataTable').getElementsByTagName('tbody')[0];
            tableBody.innerHTML = ''; // Bersihkan tabel lama
            
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.insertCell().textContent = item.bulan;
                row.insertCell().textContent = item.area;
                row.insertCell().textContent = item.produksi.toLocaleString('id-ID');
                row.insertCell().textContent = `Rp ${item.harga.toLocaleString('id-ID')}`;
                row.insertCell().textContent = `Rp ${item.penjualan.toLocaleString('id-ID')}`;
            });
        }

        // ----------------------------------------------------------
        // B. Render Grafik
        // ----------------------------------------------------------
        function renderCharts(data) {
            // Agregasi Data Bulanan (untuk Line & Bar Chart)
            const aggregated = data.reduce((acc, item) => {
                if (!acc[item.bulan]) {
                    acc[item.bulan] = { produksi: 0, penjualan: 0, hargaCount: 0, totalHarga: 0 };
                }
                acc[item.bulan].produksi += item.produksi;
                acc[item.bulan].penjualan += item.penjualan;
                acc[item.bulan].totalHarga += item.harga;
                acc[item.bulan].hargaCount++;
                return acc;
            }, {});

            const labels = Object.keys(aggregated).sort();
            const produksiData = labels.map(key => aggregated[key].produksi);
            const hargaRataData = labels.map(key => aggregated[key].totalHarga / aggregated[key].hargaCount);

            // --- 1. Grafik Batang & Garis (Produksi vs Harga) ---
            const barLineCtx = document.getElementById('barLineChart').getContext('2d');
            new Chart(barLineCtx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Produksi (Ton)',
                            data: produksiData,
                            backgroundColor: 'var(--palm-green-medium)',
                            order: 2,
                            yAxisID: 'y'
                        },
                        {
                            label: 'Harga Rata-rata (/Ton)',
                            data: hargaRataData,
                            type: 'line',
                            borderColor: 'var(--palm-accent)',
                            borderWidth: 2,
                            fill: false,
                            tension: 0.3,
                            order: 1,
                            yAxisID: 'y1'
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            title: { display: true, text: 'Produksi (Ton)' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            grid: { drawOnChartArea: false },
                            title: { display: true, text: 'Harga (IDR)' },
                            // Konfigurasi agar nilai harga terlihat lebih rapi
                            ticks: {
                                callback: function(value, index, values) {
                                    return (value / 1000000) + ' Jt';
                                }
                            }
                        }
                    },
                    plugins: { legend: { position: 'top' } }
                }
            });

            // --- 2. Diagram Lingkaran (Penjualan Berdasarkan Area/Segmen) ---
            const areaPenjualan = data.reduce((acc, item) => {
                acc[item.area] = (acc[item.area] || 0) + item.penjualan;
                return acc;
            }, {});

            const pieCtx = document.getElementById('pieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(areaPenjualan),
                    datasets: [{
                        data: Object.values(areaPenjualan),
                        backgroundColor: [
                            'var(--palm-green-dark)', 
                            'var(--palm-green-medium)', 
                            '#4CAF50', // Hijau lain
                            'var(--palm-accent)' // Aksen
                        ],
                        hoverOffset: 4
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    let label = context.label || '';
                                    if (label) { label += ': '; }
                                    if (context.parsed !== null) {
                                        label += new Intl.NumberFormat('id-ID', { style: 'currency', currency: 'IDR', minimumFractionDigits: 0 }).format(context.parsed);
                                    }
                                    return label;
                                }
                            }
                        }
                    }
                }
            });
        }

        // ----------------------------------------------------------
        // C. Filter Tabel Interaktif
        // ----------------------------------------------------------
        function setupFilters() {
            const filterBulan = document.getElementById('filterBulan');
            const filterArea = document.getElementById('filterArea');

            const applyFilters = () => {
                const bulanVal = filterBulan.value.toLowerCase().trim();
                const areaVal = filterArea.value.toLowerCase().trim();

                filteredData = rawData.filter(item => {
                    const matchesBulan = bulanVal === '' || item.bulan.toLowerCase().includes(bulanVal);
                    const matchesArea = areaVal === '' || item.area.toLowerCase().includes(areaVal);
                    return matchesBulan && matchesArea;
                });

                renderTable(filteredData);
            };

            filterBulan.addEventListener('keyup', applyFilters);
            filterArea.addEventListener('keyup', applyFilters);
        }

        // ----------------------------------------------------------
        // D. Fungsi Unduh Data
        // ----------------------------------------------------------
        function unduhData() {
            const dataToExport = filteredData.map(item => [
                item.bulan, 
                item.area, 
                item.produksi, 
                item.harga, 
                item.penjualan
            ]);

            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Bulan,Area Tanam,Produksi (Ton),Harga Rata-rata (/Ton),Penjualan (IDR)\n"; // Header
            dataToExport.forEach(rowArray => {
                let row = rowArray.join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "data_kelapa_sawit_export.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>